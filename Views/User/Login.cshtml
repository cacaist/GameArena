@{
    ViewData["Title"] = "Login";
}

<div class="d-flex justify-content-center align-items-center">
    <div class="login-box shadow-lg p-4 border-0 rounded-4 bg-secondary bg-gradient text-light" style="min-width: 500px; max-width: 800px;">

        <div class="text-center mb-4">
            <img src="@Url.Blob("logo.png")" alt="GameArena Logo" style="height: 250px;" class="mb-2" />
            <h2 class="text-info">Enter GameArena</h2>
        </div>

        <form id="loginForm" method="post" action="/User/Login">
            <div class="form-group">
                <label for="username" class="form-label fs-4 mx-1">Username</label>
                <input type="text" name="username" id="username" class="form-control rounded-pill text-center fw-semibold fs-5 " required />
            </div>

            <div class="form-group mb-4">
                <label for="password" class="form-label fs-4 mx-1">Password</label>
                <input type="password" name="password" id="password" class="form-control rounded-pill text-center fw-semibold fs-5" required />
            </div>

            @if (ViewBag.LoginError != null)
            {
                <div class="alert alert-danger text-center rounded-pill py-3">
                    @ViewBag.LoginError
                </div>
            }

            <div class="d-grid">
                <button type="submit" class="btn btn-info text-dark fw-semibold rounded-pill fs-3 login-btn-shadow">
                    <i class="bi bi-person-check-fill me-2"></i> Enter
                </button>
            </div>

        </form>

    </div>
</div>

<script>
    const form = document.getElementById("loginForm");

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const usernameInput = document.getElementById("username");
        const username = usernameInput.value;

        if (!username) {
            form.submit();
            return;
        }

        // Backend kontrolü
        fetch('/User/CheckUserExists?username=' + username)
            .then(response => {
                if (!response.ok) { throw new Error("Network response was not ok"); }
                return response.json();
            })
            .then(data => {
                let shouldSubmit = false;

                if (data.exists) {
                    shouldSubmit = true;
                } else {
                    const userConfirmed = confirm("Warior name is not exist.\n Do you agree to CREATE NEW HERO");
                    if (userConfirmed) {
                        shouldSubmit = true;
                    }
                }

                // Eğer onay verildiyse animasyonu oynat ve gönder
                if (shouldSubmit) {
                    const formCard = form.closest(".login-box");
                    formCard.style.transition = "opacity 0.6s ease";
                    formCard.style.opacity = "0";

                    setTimeout(() => {
                        form.submit();
                    }, 600);
                }
                // Onay verilmediyse hiçbir şey yapma (Sayfa sabit kalır)
            })
            .catch(error => {
                console.error('Unkown Error. Try Later:', error);
                form.submit();
            });
    });
</script>